<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Chauffeur - Dréba VTC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .online-indicator {
            animation: pulse 2s infinite;
        }
        
        .drawer-overlay {
            transition: opacity 0.3s ease;
        }
        
        .drawer {
            transition: transform 0.3s ease;
        }
        
        .drawer-hidden {
            transform: translateX(-100%);
        }
        
        .custom-marker {
            background: transparent;
            border: none;
        }
        
        .map-container {
            position: relative;
            z-index: 1;
        }
        
        .driver-map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            z-index: 1;
        }
        
        /* S'assurer que la carte Leaflet reste derrière le menu */
        .map-container .leaflet-container,
        .map-container .leaflet-pane,
        .map-container .leaflet-map-pane,
        .map-container .leaflet-tile-pane,
        .map-container .leaflet-overlay-pane,
        .map-container .leaflet-shadow-pane,
        .map-container .leaflet-marker-pane,
        .map-container .leaflet-tooltip-pane,
        .map-container .leaflet-popup-pane {
            z-index: 1 !important;
        }
        
        .photo-preview-hidden {
            display: none;
        }
        
        .photo-preview-visible {
            display: block;
        }
        
        .driver-marker-icon {
            background: #10b981;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 3px solid white;
        }
        
        .center-map-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(255, 255, 255, 0.8);
            border: 2px solid white;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .center-map-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4), 0 0 0 3px rgba(255, 255, 255, 1);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .center-map-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-green-600 to-emerald-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button id="menuBtn" class="text-white hover:text-green-200 transition" title="Ouvrir le menu">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold">Dréba VTC - Chauffeur</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="driverName" class="text-sm font-semibold">Chargement...</div>
                    <button id="logoutBtn" class="bg-white text-green-600 px-4 py-2 rounded-lg hover:bg-green-50 transition font-semibold">
                        <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Menu Latéral (Drawer) -->
    <div id="drawerOverlay" class="drawer-overlay fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeDrawer()"></div>
    <div id="drawer" class="drawer drawer-hidden fixed left-0 top-0 h-full w-80 bg-white shadow-2xl z-50 overflow-y-auto">
        <div class="p-6 bg-gradient-to-br from-green-600 to-emerald-600 text-white">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Menu</h2>
                <button onclick="closeDrawer()" class="text-white hover:text-green-200" title="Fermer le menu">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="flex items-center space-x-4 mb-6">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-green-600 text-2xl"></i>
                </div>
                <div>
                    <div id="drawerDriverName" class="font-bold text-lg">Chargement...</div>
                    <div id="drawerDriverPhone" class="text-green-100 text-sm">+227...</div>
                </div>
            </div>
        </div>
        <div class="py-4">
            <a href="#" onclick="showSection('dashboard'); closeDrawer(); return false;" class="menu-item flex items-center px-6 py-4 hover:bg-gray-100 transition">
                <i class="fas fa-home text-green-600 w-6"></i>
                <span class="ml-4 font-medium">Tableau de bord</span>
            </a>
            <a href="#" onclick="showSection('rides'); closeDrawer(); return false;" class="menu-item flex items-center px-6 py-4 hover:bg-gray-100 transition">
                <i class="fas fa-list text-green-600 w-6"></i>
                <span class="ml-4 font-medium">Mes courses</span>
            </a>
            <a href="#" onclick="showSection('history'); closeDrawer(); return false;" class="menu-item flex items-center px-6 py-4 hover:bg-gray-100 transition">
                <i class="fas fa-history text-green-600 w-6"></i>
                <span class="ml-4 font-medium">Historique</span>
            </a>
            <a href="#" onclick="showSection('stats'); closeDrawer(); return false;" class="menu-item flex items-center px-6 py-4 hover:bg-gray-100 transition">
                <i class="fas fa-chart-line text-green-600 w-6"></i>
                <span class="ml-4 font-medium">Statistiques</span>
            </a>
            <a href="#" onclick="showSection('profile'); closeDrawer(); return false;" class="menu-item flex items-center px-6 py-4 hover:bg-gray-100 transition">
                <i class="fas fa-user-circle text-green-600 w-6"></i>
                <span class="ml-4 font-medium">Mon profil</span>
            </a>
            <a href="#" onclick="showSection('settings'); closeDrawer(); return false;" class="menu-item flex items-center px-6 py-4 hover:bg-gray-100 transition">
                <i class="fas fa-cog text-green-600 w-6"></i>
                <span class="ml-4 font-medium">Paramètres</span>
            </a>
        </div>
    </div>

    <!-- Contenu Principal -->
    <div class="container mx-auto px-4 py-6">
        <!-- Section Tableau de Bord (par défaut) -->
        <div id="dashboardSection" class="section">
            <!-- Bouton En ligne/Hors ligne -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div id="onlineStatus" class="w-4 h-4 rounded-full bg-gray-400 online-indicator"></div>
                        <div>
                            <div class="font-bold text-lg" id="statusText">Hors ligne</div>
                            <div class="text-sm text-gray-600" id="statusSubtext">Activez pour recevoir des courses</div>
                        </div>
                    </div>
                    <button id="toggleOnlineBtn" class="bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-500 transition">
                        <i class="fas fa-power-off mr-2"></i>Se mettre en ligne
                    </button>
                </div>
            </div>

            <!-- Statistiques Rapides -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-gray-600 text-sm">Courses acceptées</div>
                            <div class="text-2xl font-bold text-green-600" id="acceptedRides">0</div>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-gray-600 text-sm">Courses refusées</div>
                            <div class="text-2xl font-bold text-red-600" id="rejectedRides">0</div>
                        </div>
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-times-circle text-red-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-gray-600 text-sm">Appels clients</div>
                            <div class="text-2xl font-bold text-blue-600" id="clientCalls">0</div>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-phone text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-gray-600 text-sm">Appels admin</div>
                            <div class="text-2xl font-bold text-purple-600" id="adminCalls">0</div>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user-shield text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-gray-600 text-sm">Note moyenne</div>
                            <div class="text-2xl font-bold text-yellow-600" id="averageRating">5.0</div>
                        </div>
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-star text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carte -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Ma position</h2>
                <div class="map-container">
                    <div id="driverMap" class="driver-map"></div>
                    <button id="centerMapBtn" class="center-map-btn" title="Centrer sur ma position">
                        <i class="fas fa-crosshairs text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Demandes de course en temps réel -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Nouvelles demandes</h2>
                    <div id="requestsCount" class="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-semibold">0</div>
                </div>
                <div id="rideRequestsList" class="space-y-4">
                    <!-- Les demandes seront ajoutées ici dynamiquement -->
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-taxi text-4xl mb-4"></i>
                        <p>Aucune demande pour le moment</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Mes Courses -->
        <div id="ridesSection" class="section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Mes courses</h2>
                <div id="myRidesList" class="space-y-4">
                    <!-- Les courses seront ajoutées ici -->
                </div>
            </div>
        </div>

        <!-- Section Historique -->
        <div id="historySection" class="section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Historique des appels</h2>
                    <select id="historyPeriod" class="px-4 py-2 border rounded-lg" title="Période de l'historique" aria-label="Période de l'historique">
                        <option value="day">Aujourd'hui</option>
                        <option value="week">Cette semaine</option>
                        <option value="month">Ce mois</option>
                        <option value="all">Tout</option>
                    </select>
                </div>
                <div id="historyList" class="space-y-4">
                    <!-- L'historique sera ajouté ici -->
                </div>
            </div>
        </div>

        <!-- Section Statistiques -->
        <div id="statsSection" class="section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Statistiques détaillées</h2>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">Clients fréquents</h3>
                    <div id="frequentClients" class="space-y-3">
                        <!-- Les clients fréquents seront ajoutés ici -->
                    </div>
                </div>
                <div id="detailedStats" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Les statistiques seront ajoutées ici -->
                </div>
            </div>
        </div>

        <!-- Section Profil -->
        <div id="profileSection" class="section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-6">Mon profil</h2>
                <div id="profileContent" class="space-y-6">
                    <!-- Informations personnelles -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold mb-4">Informations personnelles</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Photo de profil</label>
                                <div class="flex items-center space-x-4">
                                    <img id="profilePhotoPreview" src="" alt="Photo de profil" class="w-24 h-24 rounded-full object-cover border-2 border-gray-300 photo-preview-hidden">
                                    <div>
                                        <input type="file" id="profilePhotoInput" accept="image/*" class="hidden" title="Choisir une photo de profil" aria-label="Choisir une photo de profil">
                                        <button onclick="document.getElementById('profilePhotoInput').click()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                            <i class="fas fa-upload mr-2"></i>Choisir une photo
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Prénom</label>
                                <input type="text" id="editFirstName" class="w-full px-4 py-2 border rounded-lg" placeholder="Prénom">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Nom</label>
                                <input type="text" id="editLastName" class="w-full px-4 py-2 border rounded-lg" placeholder="Nom">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Email</label>
                                <input type="email" id="editEmail" class="w-full px-4 py-2 border rounded-lg" placeholder="Email">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Numéro de téléphone</label>
                                <input type="tel" id="editPhone" class="w-full px-4 py-2 border rounded-lg" placeholder="Numéro">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Permis de conduire</label>
                                <input type="text" id="editLicense" class="w-full px-4 py-2 border rounded-lg" placeholder="Numéro de permis">
                            </div>
                        </div>
                        <button onclick="savePersonalInfo()" class="mt-4 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                            <i class="fas fa-save mr-2"></i>Enregistrer les modifications
                        </button>
                    </div>

                    <!-- Informations véhicule -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Informations véhicule</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Photo du véhicule</label>
                                <div class="flex items-center space-x-4">
                                    <img id="vehiclePhotoPreview" src="" alt="Photo du véhicule" class="w-32 h-32 rounded-lg object-cover border-2 border-gray-300 photo-preview-hidden">
                                    <div>
                                        <input type="file" id="vehiclePhotoInput" accept="image/*" class="hidden" title="Choisir une photo du véhicule" aria-label="Choisir une photo du véhicule">
                                        <button onclick="document.getElementById('vehiclePhotoInput').click()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                            <i class="fas fa-upload mr-2"></i>Choisir une photo
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Plaque d'immatriculation</label>
                                <input type="text" id="editPlate" class="w-full px-4 py-2 border rounded-lg" placeholder="Plaque">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Marque du véhicule</label>
                                <input type="text" id="editVehicleBrand" class="w-full px-4 py-2 border rounded-lg" placeholder="Marque">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Couleur du véhicule</label>
                                <input type="text" id="editVehicleColor" class="w-full px-4 py-2 border rounded-lg" placeholder="Couleur">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Type de service</label>
                                <select id="editServiceType" class="w-full px-4 py-2 border rounded-lg" title="Type de service" aria-label="Type de service">
                                    <option value="SIMPLE">Taxi Simple</option>
                                    <option value="STANDARD">Taxi Standard</option>
                                    <option value="VIP">Taxi VIP</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="saveVehicleInfo()" class="mt-4 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                            <i class="fas fa-save mr-2"></i>Enregistrer les modifications
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Paramètres -->
        <div id="settingsSection" class="section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-6">Paramètres</h2>
                <div id="settingsContent" class="space-y-6">
                    <!-- Thème de couleur -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold mb-4">Thème de l'interface</h3>
                        <div class="flex items-center space-x-4">
                            <label class="block text-sm font-medium">Couleur principale :</label>
                            <input type="color" id="themeColor" value="#10b981" class="w-16 h-10 border rounded-lg cursor-pointer" title="Couleur du thème" aria-label="Couleur du thème">
                            <button onclick="applyThemeColor()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                <i class="fas fa-palette mr-2"></i>Appliquer
                            </button>
                            <button onclick="resetThemeColor()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                <i class="fas fa-undo mr-2"></i>Réinitialiser
                            </button>
                        </div>
                    </div>

                    <!-- Supprimer le compte -->
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-semibold mb-4 text-red-600">Zone de danger</h3>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p class="text-sm text-red-800 mb-4">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                La suppression de votre compte est définitive. Toutes vos données seront perdues.
                            </p>
                            <button onclick="deleteAccount()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">
                                <i class="fas fa-trash mr-2"></i>Supprimer mon compte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCF55ufr-zZ3K-b6FlIUAEcjsicbXmNZo8",
            authDomain: "dreba-vtc-niger.firebaseapp.com",
            projectId: "dreba-vtc-niger",
            storageBucket: "dreba-vtc-niger.firebasestorage.app",
            messagingSenderId: "307924459980",
            appId: "1:307924459980:web:025fab54728dfa01e7bd69",
            measurementId: "G-F3ZJFEPZHF"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Variables globales
        let currentDriverId = null;
        let driverData = null;
        let driverMap = null;
        let driverMarker = null;
        let locationWatch = null;
        let isOnline = false;
        let rideRequestsListener = null;

        // Récupérer l'ID du chauffeur depuis l'URL
        function getDriverIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('driverId');
        }

        // Vérifier si le chauffeur est connecté
        async function checkDriverSession() {
            const driverId = getDriverIdFromURL();
            if (!driverId) {
                alert('Session expirée. Veuillez vous reconnecter.');
                window.location.href = 'Dréba VTC.html';
                return;
            }

            try {
                const driverDoc = await db.collection('drivers').doc(driverId).get();
                if (!driverDoc.exists) {
                    alert('Chauffeur introuvable. Veuillez vous reconnecter.');
                    window.location.href = 'Dréba VTC.html';
                    return;
                }

                currentDriverId = driverId;
                driverData = driverDoc.data();
                isOnline = driverData.isOnline || false;

                // Afficher les informations du chauffeur
                displayDriverInfo();
                initializeMap();
                loadDriverStats();
                setupRideRequestsListener();
                updateOnlineStatus();

            } catch (error) {
                console.error('Erreur lors de la vérification de session:', error);
                alert('Erreur lors du chargement. Veuillez réessayer.');
            }
        }

        // Afficher les informations du chauffeur
        function displayDriverInfo() {
            const name = `${driverData.firstName || ''} ${driverData.lastName || ''}`.trim();
            document.getElementById('driverName').textContent = name;
            document.getElementById('drawerDriverName').textContent = name;
            document.getElementById('drawerDriverPhone').textContent = `+227${driverData.phone || ''}`;
        }

        // Initialiser la carte
        function initializeMap() {
            const defaultLat = driverData.location?.lat || 13.5127;
            const defaultLng = driverData.location?.lng || 2.1124;

            driverMap = L.map('driverMap').setView([defaultLat, defaultLng], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(driverMap);

            // Ajouter le marqueur du chauffeur
            const driverIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="driver-marker-icon">
                    <i class="fas fa-taxi"></i>
                </div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            driverMarker = L.marker([defaultLat, defaultLng], { icon: driverIcon })
                .addTo(driverMap)
                .bindPopup(`<strong>${driverData.firstName} ${driverData.lastName}</strong><br>Votre position`);

            // Ajouter le bouton "Ma position"
            setupCenterMapButton();
        }

        // Configurer le bouton "Ma position"
        function setupCenterMapButton() {
            const centerBtn = document.getElementById('centerMapBtn');
            if (centerBtn) {
                centerBtn.addEventListener('click', function() {
                    centerMapOnDriver();
                });
            }
        }

        // Centrer la carte sur la position du chauffeur
        function centerMapOnDriver() {
            if (!driverMap || !driverMarker) {
                return;
            }

            // Obtenir la position actuelle du marqueur
            const position = driverMarker.getLatLng();
            
            // Centrer la carte sur cette position avec un zoom approprié
            driverMap.setView(position, 16, {
                animate: true,
                duration: 0.5
            });

            // Ouvrir le popup du marqueur
            driverMarker.openPopup();
        }

        // Démarrer le suivi de localisation
        function startLocationTracking() {
            if (!navigator.geolocation) {
                alert('La géolocalisation n\'est pas supportée par votre navigateur.');
                return;
            }

            locationWatch = navigator.geolocation.watchPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Mettre à jour le marqueur sur la carte
                    if (driverMarker) {
                        driverMarker.setLatLng([lat, lng]);
                        driverMap.setView([lat, lng], driverMap.getZoom());
                    }

                    // Mettre à jour dans Firestore
                    try {
                        await db.collection('drivers').doc(currentDriverId).update({
                            location: {
                                lat: lat,
                                lng: lng
                            },
                            locationUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (error) {
                        console.error('Erreur mise à jour localisation:', error);
                    }
                },
                (error) => {
                    console.error('Erreur géolocalisation:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Arrêter le suivi de localisation
        function stopLocationTracking() {
            if (locationWatch !== null) {
                navigator.geolocation.clearWatch(locationWatch);
                locationWatch = null;
            }
        }

        // Toggle en ligne/hors ligne
        document.getElementById('toggleOnlineBtn').addEventListener('click', async function() {
            try {
                const newStatus = !isOnline;
                await db.collection('drivers').doc(currentDriverId).update({
                    isOnline: newStatus,
                    statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                isOnline = newStatus;
                updateOnlineStatus();

                if (newStatus) {
                    startLocationTracking();
                } else {
                    stopLocationTracking();
                }
            } catch (error) {
                console.error('Erreur changement statut:', error);
                alert('Erreur lors du changement de statut.');
            }
        });

        // Mettre à jour l'affichage du statut
        function updateOnlineStatus() {
            const statusIndicator = document.getElementById('onlineStatus');
            const statusText = document.getElementById('statusText');
            const statusSubtext = document.getElementById('statusSubtext');
            const toggleBtn = document.getElementById('toggleOnlineBtn');

            if (isOnline) {
                statusIndicator.className = 'w-4 h-4 rounded-full bg-green-500 online-indicator';
                statusText.textContent = 'En ligne';
                statusSubtext.textContent = 'Vous recevez des demandes de course';
                toggleBtn.className = 'bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 transition';
                toggleBtn.innerHTML = '<i class="fas fa-power-off mr-2"></i>Se mettre hors ligne';
            } else {
                statusIndicator.className = 'w-4 h-4 rounded-full bg-gray-400';
                statusText.textContent = 'Hors ligne';
                statusSubtext.textContent = 'Activez pour recevoir des courses';
                toggleBtn.className = 'bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition';
                toggleBtn.innerHTML = '<i class="fas fa-power-off mr-2"></i>Se mettre en ligne';
            }
        }

        // Charger les statistiques du chauffeur
        async function loadDriverStats() {
            try {
                // Compter les courses acceptées
                const acceptedSnapshot = await db.collection('bookings')
                    .where('driverId', '==', currentDriverId)
                    .where('status', '==', 'accepted')
                    .get();
                
                // Compter les courses refusées
                const rejectedSnapshot = await db.collection('bookings')
                    .where('driverId', '==', currentDriverId)
                    .where('status', '==', 'rejected')
                    .get();

                // Compter les courses complétées
                const completedSnapshot = await db.collection('bookings')
                    .where('driverId', '==', currentDriverId)
                    .where('status', '==', 'completed')
                    .get();

                document.getElementById('acceptedRides').textContent = acceptedSnapshot.size;
                document.getElementById('rejectedRides').textContent = rejectedSnapshot.size;

                // Compter les appels reçus
                await loadCallStats();
            } catch (error) {
                console.error('Erreur chargement stats:', error);
            }
        }

        // Charger les statistiques d'appels
        async function loadCallStats() {
            try {
                if (!driverData || !driverData.phone) {
                    document.getElementById('clientCalls').textContent = '0';
                    document.getElementById('adminCalls').textContent = '0';
                    return;
                }

                const driverPhone = driverData.phone.toString();
                
                // Récupérer tous les appels
                const allCallsSnapshot = await db.collection('calls').get();
                
                let clientCallsCount = 0;
                let adminCallsCount = 0;

                allCallsSnapshot.forEach((doc) => {
                    const callData = doc.data();
                    const callPhone = callData.phoneNumber ? callData.phoneNumber.toString().replace('+227', '').replace('227', '') : '';
                    
                    // Vérifier si l'appel est pour ce chauffeur
                    if (callPhone === driverPhone) {
                        const callType = callData.callType || '';
                        
                        // Appels des clients (depuis la carte/recherche)
                        if (callType === 'reservation' || callType === 'client' || callType === 'booking') {
                            clientCallsCount++;
                        }
                        // Appels de l'admin
                        else if (callType === 'admin' || callType === 'management') {
                            adminCallsCount++;
                        }
                        // Par défaut, si pas de type spécifié, considérer comme appel client
                        else if (!callType || callType === '') {
                            clientCallsCount++;
                        }
                    }
                });

                document.getElementById('clientCalls').textContent = clientCallsCount;
                document.getElementById('adminCalls').textContent = adminCallsCount;
            } catch (error) {
                console.error('Erreur chargement stats appels:', error);
                document.getElementById('clientCalls').textContent = '0';
                document.getElementById('adminCalls').textContent = '0';
            }
        }

        // Écouter les nouvelles demandes de course
        function setupRideRequestsListener() {
            if (rideRequestsListener) {
                rideRequestsListener();
            }

            rideRequestsListener = db.collection('bookings')
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    const requestsList = document.getElementById('rideRequestsList');
                    requestsList.innerHTML = '';

                    if (snapshot.empty) {
                        requestsList.innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-taxi text-4xl mb-4"></i>
                                <p>Aucune demande pour le moment</p>
                            </div>
                        `;
                        document.getElementById('requestsCount').textContent = '0';
                        return;
                    }

                    document.getElementById('requestsCount').textContent = snapshot.size;

                    snapshot.forEach((doc) => {
                        const request = doc.data();
                        const requestCard = createRideRequestCard(doc.id, request);
                        requestsList.appendChild(requestCard);
                    });
                });
        }

        // Créer une carte de demande de course
        function createRideRequestCard(requestId, request) {
            const card = document.createElement('div');
            card.className = 'bg-gray-50 border-2 border-green-200 rounded-lg p-4 hover:border-green-400 transition';
            
            const pickupAddress = request.pickupAddress || 'Adresse non spécifiée';
            const taxiType = request.taxiType || 'simple';
            const clientPhone = request.clientPhone || 'N/A';
            const distance = request.distance || 'N/A';

            card.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-map-marker-alt text-green-600"></i>
                            <span class="font-semibold">${pickupAddress}</span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div><i class="fas fa-taxi mr-2"></i>Type: ${taxiType}</div>
                            <div><i class="fas fa-phone mr-2"></i>Client: ${clientPhone}</div>
                            ${distance !== 'N/A' ? `<div><i class="fas fa-route mr-2"></i>Distance: ${distance} km</div>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button onclick="acceptRide('${requestId}')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-semibold">
                            <i class="fas fa-check mr-2"></i>Accepter
                        </button>
                        <button onclick="rejectRide('${requestId}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition font-semibold">
                            <i class="fas fa-times mr-2"></i>Refuser
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // Accepter une course
        async function acceptRide(requestId) {
            if (!confirm('Voulez-vous accepter cette course ?')) {
                return;
            }

            try {
                await db.collection('bookings').doc(requestId).update({
                    status: 'accepted',
                    driverId: currentDriverId,
                    acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Course acceptée !');
                loadDriverStats();
            } catch (error) {
                console.error('Erreur acceptation course:', error);
                alert('Erreur lors de l\'acceptation de la course.');
            }
        }

        // Refuser une course
        async function rejectRide(requestId) {
            if (!confirm('Voulez-vous refuser cette course ?')) {
                return;
            }

            try {
                await db.collection('bookings').doc(requestId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Course refusée.');
                loadDriverStats();
            } catch (error) {
                console.error('Erreur refus course:', error);
                alert('Erreur lors du refus de la course.');
            }
        }

        // Fonctions globales pour les boutons
        window.acceptRide = acceptRide;
        window.rejectRide = rejectRide;

        // Menu Drawer
        document.getElementById('menuBtn').addEventListener('click', function() {
            document.getElementById('drawerOverlay').classList.remove('hidden');
            document.getElementById('drawer').classList.remove('drawer-hidden');
        });

        function closeDrawer() {
            document.getElementById('drawerOverlay').classList.add('hidden');
            document.getElementById('drawer').classList.add('drawer-hidden');
        }

        // Navigation entre sections
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Charger les données selon la section
            if (sectionName === 'profile') {
                loadProfileData();
            } else if (sectionName === 'history') {
                loadCallHistory();
            } else if (sectionName === 'stats') {
                loadFrequentClients();
            } else if (sectionName === 'settings') {
                loadThemeColor();
            }
        }

        // Déconnexion
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            if (!confirm('Voulez-vous vous déconnecter ?')) {
                return;
            }

            try {
                // Enregistrer la date de dernière déconnexion (sans changer isOnline)
                // Le statut isOnline ne change que via le bouton "Se mettre hors ligne"
                await db.collection('drivers').doc(currentDriverId).update({
                    lastLogout: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Arrêter le suivi de localisation
                stopLocationTracking();
                
                // Arrêter l'écoute des demandes de course
                if (rideRequestsListener) {
                    rideRequestsListener();
                }

                // Rediriger vers la page principale
                window.location.href = 'Dréba VTC.html';
            } catch (error) {
                console.error('Erreur déconnexion:', error);
                // Rediriger quand même même en cas d'erreur
                window.location.href = 'Dréba VTC.html';
            }
        });

        // ============================================
        // Gestion du Profil
        // ============================================
        
        // Charger les données du profil
        function loadProfileData() {
            if (!driverData) return;
            
            document.getElementById('editFirstName').value = driverData.firstName || '';
            document.getElementById('editLastName').value = driverData.lastName || '';
            document.getElementById('editEmail').value = driverData.email || '';
            document.getElementById('editPhone').value = driverData.phone || '';
            document.getElementById('editLicense').value = driverData.license || '';
            document.getElementById('editPlate').value = driverData.plate || '';
            document.getElementById('editVehicleBrand').value = driverData.vehicleBrand || '';
            document.getElementById('editVehicleColor').value = driverData.vehicleColor || '';
            document.getElementById('editServiceType').value = driverData.serviceType || 'SIMPLE';
            
            // Afficher les photos si disponibles
            if (driverData.profilePhoto) {
                const profilePreview = document.getElementById('profilePhotoPreview');
                profilePreview.src = driverData.profilePhoto;
                profilePreview.classList.remove('photo-preview-hidden');
                profilePreview.classList.add('photo-preview-visible');
            }
            if (driverData.vehiclePhoto) {
                const vehiclePreview = document.getElementById('vehiclePhotoPreview');
                vehiclePreview.src = driverData.vehiclePhoto;
                vehiclePreview.classList.remove('photo-preview-hidden');
                vehiclePreview.classList.add('photo-preview-visible');
            }
        }

        // Upload photo de profil
        document.getElementById('profilePhotoInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Vérifications préalables
            if (!currentDriverId) {
                alert('Erreur: Session expirée. Veuillez vous reconnecter.');
                return;
            }
            
            if (!storage) {
                alert('Erreur: Firebase Storage n\'est pas initialisé.');
                console.error('❌ Firebase Storage non initialisé');
                return;
            }
            
            // Vérifier le type de fichier
            if (!file.type.startsWith('image/')) {
                alert('Veuillez sélectionner un fichier image.');
                return;
            }
            
            // Vérifier la taille (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('L\'image est trop grande. Taille maximale: 5MB');
                return;
            }
            
            // Afficher un aperçu immédiat de l'image sélectionnée
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('profilePhotoPreview');
                preview.src = e.target.result;
                preview.classList.remove('photo-preview-hidden');
                preview.classList.add('photo-preview-visible');
            };
            reader.readAsDataURL(file);
            
            // Trouver le bouton d'upload pour afficher le statut
            const uploadBtn = document.querySelector('button[onclick*="profilePhotoInput"]');
            const originalBtnText = uploadBtn ? uploadBtn.innerHTML : '';
            if (uploadBtn) {
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Upload en cours...';
            }
            
            try {
                // Vérifier que storage est bien initialisé
                if (!storage || typeof storage.ref !== 'function') {
                    throw new Error('Firebase Storage n\'est pas correctement initialisé. Vérifiez que Storage est activé dans Firebase Console.');
                }
                
                console.log('📤 Début upload photo de profil...', { 
                    driverId: currentDriverId, 
                    fileName: file.name,
                    fileSize: (file.size / 1024).toFixed(2) + ' KB',
                    fileType: file.type,
                    storageInitialized: !!storage
                });
                
                const storageRef = storage.ref(`drivers/${currentDriverId}/profile.jpg`);
                const uploadTask = storageRef.put(file);
                
                // Écouter la progression de l'upload
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('📤 Progression upload:', Math.round(progress) + '%');
                        if (uploadBtn) {
                            uploadBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Upload ${Math.round(progress)}%...`;
                        }
                    },
                    (error) => {
                        console.error('❌ Erreur upload:', error);
                        console.error('Détails erreur:', {
                            code: error.code,
                            message: error.message
                        });
                        
                        let errorMessage = 'Erreur lors de l\'upload de la photo.';
                        let errorDetails = '';
                        
                        if (error.code === 'storage/unauthorized') {
                            errorMessage = 'Erreur: Permissions insuffisantes.';
                            errorDetails = 'Vérifiez les règles Firebase Storage dans la console Firebase. Allez dans Storage → Règles et copiez les règles depuis le fichier "Rules fire base.txt".';
                        } else if (error.code === 'storage/quota-exceeded') {
                            errorMessage = 'Erreur: Quota de stockage dépassé.';
                            errorDetails = 'Vérifiez votre plan Firebase ou supprimez des fichiers anciens.';
                        } else if (error.code === 'storage/object-not-found') {
                            errorMessage = 'Erreur: Fichier non trouvé.';
                            errorDetails = 'C\'est normal lors de la première upload. Réessayez.';
                        } else if (error.code === 'storage/canceled') {
                            errorMessage = 'Upload annulé.';
                            errorDetails = 'L\'upload a été annulé. Réessayez.';
                        } else if (error.message && error.message.includes('not initialized')) {
                            errorMessage = 'Firebase Storage n\'est pas initialisé.';
                            errorDetails = 'Vérifiez que Storage est activé dans Firebase Console (Storage → Commencer).';
                        } else {
                            errorMessage = 'Erreur: ' + (error.message || 'Erreur inconnue');
                            errorDetails = 'Code erreur: ' + (error.code || 'N/A') + '. Ouvrez la console (F12) pour plus de détails.';
                        }
                        
                        alert(errorMessage + '\n\n' + errorDetails);
                        if (uploadBtn) {
                            uploadBtn.disabled = false;
                            uploadBtn.innerHTML = originalBtnText;
                        }
                    },
                    async () => {
                        // Upload réussi
                        try {
                            const url = await storageRef.getDownloadURL();
                            console.log('✅ URL photo obtenue:', url);
                            
                            await db.collection('drivers').doc(currentDriverId).update({
                                profilePhoto: url,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            console.log('✅ Photo sauvegardée dans Firestore');
                            
                            // Mettre à jour l'aperçu avec l'URL Firebase
                            const profilePreview = document.getElementById('profilePhotoPreview');
                            profilePreview.src = url;
                            profilePreview.classList.remove('photo-preview-hidden');
                            profilePreview.classList.add('photo-preview-visible');
                            driverData.profilePhoto = url;
                            
                            alert('Photo de profil mise à jour avec succès !');
                        } catch (error) {
                            console.error('❌ Erreur mise à jour Firestore:', error);
                            alert('Erreur lors de la sauvegarde: ' + error.message);
                        } finally {
                            if (uploadBtn) {
                                uploadBtn.disabled = false;
                                uploadBtn.innerHTML = originalBtnText;
                            }
                        }
                    }
                );
            } catch (error) {
                console.error('❌ Erreur upload photo:', error);
                alert('Erreur lors de l\'upload de la photo: ' + error.message);
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = originalBtnText;
                }
            }
        });

        // Upload photo du véhicule
        document.getElementById('vehiclePhotoInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Vérifications préalables
            if (!currentDriverId) {
                alert('Erreur: Session expirée. Veuillez vous reconnecter.');
                return;
            }
            
            if (!storage) {
                alert('Erreur: Firebase Storage n\'est pas initialisé.');
                console.error('❌ Firebase Storage non initialisé');
                return;
            }
            
            // Vérifier le type de fichier
            if (!file.type.startsWith('image/')) {
                alert('Veuillez sélectionner un fichier image.');
                return;
            }
            
            // Vérifier la taille (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('L\'image est trop grande. Taille maximale: 5MB');
                return;
            }
            
            // Afficher un aperçu immédiat de l'image sélectionnée
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('vehiclePhotoPreview');
                preview.src = e.target.result;
                preview.classList.remove('photo-preview-hidden');
                preview.classList.add('photo-preview-visible');
            };
            reader.readAsDataURL(file);
            
            // Trouver le bouton d'upload pour afficher le statut
            const uploadBtn = document.querySelector('button[onclick*="vehiclePhotoInput"]');
            const originalBtnText = uploadBtn ? uploadBtn.innerHTML : '';
            if (uploadBtn) {
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Upload en cours...';
            }
            
            try {
                console.log('📤 Début upload photo véhicule...', { 
                    driverId: currentDriverId, 
                    fileName: file.name,
                    fileSize: (file.size / 1024).toFixed(2) + ' KB',
                    fileType: file.type
                });
                
                const storageRef = storage.ref(`drivers/${currentDriverId}/vehicle.jpg`);
                const uploadTask = storageRef.put(file);
                
                // Écouter la progression de l'upload
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('📤 Progression upload:', Math.round(progress) + '%');
                        if (uploadBtn) {
                            uploadBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Upload ${Math.round(progress)}%...`;
                        }
                    },
                    (error) => {
                        console.error('❌ Erreur upload:', error);
                        console.error('Détails erreur:', {
                            code: error.code,
                            message: error.message
                        });
                        
                        let errorMessage = 'Erreur lors de l\'upload de la photo.';
                        let errorDetails = '';
                        
                        if (error.code === 'storage/unauthorized') {
                            errorMessage = 'Erreur: Permissions insuffisantes.';
                            errorDetails = 'Vérifiez les règles Firebase Storage dans la console Firebase. Allez dans Storage → Règles et copiez les règles depuis le fichier "Rules fire base.txt".';
                        } else if (error.code === 'storage/quota-exceeded') {
                            errorMessage = 'Erreur: Quota de stockage dépassé.';
                            errorDetails = 'Vérifiez votre plan Firebase ou supprimez des fichiers anciens.';
                        } else if (error.code === 'storage/object-not-found') {
                            errorMessage = 'Erreur: Fichier non trouvé.';
                            errorDetails = 'C\'est normal lors de la première upload. Réessayez.';
                        } else if (error.code === 'storage/canceled') {
                            errorMessage = 'Upload annulé.';
                            errorDetails = 'L\'upload a été annulé. Réessayez.';
                        } else if (error.message && error.message.includes('not initialized')) {
                            errorMessage = 'Firebase Storage n\'est pas initialisé.';
                            errorDetails = 'Vérifiez que Storage est activé dans Firebase Console (Storage → Commencer).';
                        } else {
                            errorMessage = 'Erreur: ' + (error.message || 'Erreur inconnue');
                            errorDetails = 'Code erreur: ' + (error.code || 'N/A') + '. Ouvrez la console (F12) pour plus de détails.';
                        }
                        
                        alert(errorMessage + '\n\n' + errorDetails);
                        if (uploadBtn) {
                            uploadBtn.disabled = false;
                            uploadBtn.innerHTML = originalBtnText;
                        }
                    },
                    async () => {
                        // Upload réussi
                        try {
                            const url = await storageRef.getDownloadURL();
                            console.log('✅ URL photo obtenue:', url);
                            
                            await db.collection('drivers').doc(currentDriverId).update({
                                vehiclePhoto: url,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            console.log('✅ Photo sauvegardée dans Firestore');
                            
                            // Mettre à jour l'aperçu avec l'URL Firebase
                            const vehiclePreview = document.getElementById('vehiclePhotoPreview');
                            vehiclePreview.src = url;
                            vehiclePreview.classList.remove('photo-preview-hidden');
                            vehiclePreview.classList.add('photo-preview-visible');
                            driverData.vehiclePhoto = url;
                            
                            alert('Photo du véhicule mise à jour avec succès !');
                        } catch (error) {
                            console.error('❌ Erreur mise à jour Firestore:', error);
                            alert('Erreur lors de la sauvegarde: ' + error.message);
                        } finally {
                            if (uploadBtn) {
                                uploadBtn.disabled = false;
                                uploadBtn.innerHTML = originalBtnText;
                            }
                        }
                    }
                );
            } catch (error) {
                console.error('❌ Erreur upload photo:', error);
                alert('Erreur lors de l\'upload de la photo: ' + error.message);
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = originalBtnText;
                }
            }
        });

        // Sauvegarder les informations personnelles
        window.savePersonalInfo = async function() {
            try {
                const updates = {
                    firstName: document.getElementById('editFirstName').value.trim(),
                    lastName: document.getElementById('editLastName').value.trim(),
                    email: document.getElementById('editEmail').value.trim(),
                    phone: document.getElementById('editPhone').value.trim(),
                    license: document.getElementById('editLicense').value.trim(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('drivers').doc(currentDriverId).update(updates);
                
                // Mettre à jour les données locales
                Object.assign(driverData, updates);
                displayDriverInfo();
                
                alert('Informations personnelles mises à jour avec succès !');
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                alert('Erreur lors de la sauvegarde.');
            }
        };

        // Sauvegarder les informations du véhicule
        window.saveVehicleInfo = async function() {
            try {
                const updates = {
                    plate: document.getElementById('editPlate').value.trim(),
                    vehicleBrand: document.getElementById('editVehicleBrand').value.trim(),
                    vehicleColor: document.getElementById('editVehicleColor').value.trim(),
                    serviceType: document.getElementById('editServiceType').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('drivers').doc(currentDriverId).update(updates);
                
                // Mettre à jour les données locales
                Object.assign(driverData, updates);
                
                alert('Informations du véhicule mises à jour avec succès !');
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                alert('Erreur lors de la sauvegarde.');
            }
        };

        // ============================================
        // Gestion de l'Historique
        // ============================================
        
        // Charger l'historique des appels
        async function loadCallHistory() {
            try {
                const period = document.getElementById('historyPeriod').value;
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';
                
                if (!driverData || !driverData.phone) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">Aucun historique disponible</p>';
                    return;
                }
                
                const driverPhone = driverData.phone.toString();
                const now = new Date();
                let startDate = new Date(0);
                
                if (period === 'day') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                } else if (period === 'week') {
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                } else if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                }
                
                const allCallsSnapshot = await db.collection('calls').get();
                
                const calls = [];
                allCallsSnapshot.forEach((doc) => {
                    const callData = doc.data();
                    const callPhone = callData.phoneNumber ? callData.phoneNumber.toString().replace('+227', '').replace('227', '') : '';
                    
                    if (callPhone === driverPhone) {
                        const callDate = callData.timestamp ? callData.timestamp.toDate() : new Date(callData.date);
                        if (period === 'all' || callDate >= startDate) {
                            calls.push({
                                id: doc.id,
                                ...callData,
                                callDate: callDate
                            });
                        }
                    }
                });
                
                if (calls.length === 0) {
                    historyList.innerHTML = '<p class="text-center text-gray-500 py-8">Aucun appel pour cette période</p>';
                    return;
                }
                
                historyList.innerHTML = calls.map(call => {
                    const dateStr = call.callDate.toLocaleString('fr-FR');
                    const callType = call.callType === 'admin' ? 'Admin' : 'Client';
                    const isAdmin = call.callType === 'admin';
                    const bgColor = isAdmin ? 'bg-purple-100' : 'bg-blue-100';
                    const textColor = isAdmin ? 'text-purple-600' : 'text-blue-600';
                    const location = call.location ? `${call.location.lat.toFixed(4)}, ${call.location.lng.toFixed(4)}` : 'Non disponible';
                    
                    return `
                        <div class="border rounded-lg p-4 hover:bg-gray-50 transition">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 ${bgColor} rounded-full flex items-center justify-center">
                                        <i class="fas fa-phone ${textColor}"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold">Appel ${callType}</div>
                                        <div class="text-sm text-gray-600">${dateStr}</div>
                                    </div>
                                </div>
                                <span class="px-3 py-1 ${bgColor} ${textColor} rounded-full text-sm font-semibold">
                                    ${callType}
                                </span>
                            </div>
                            <div class="mt-2 text-sm text-gray-600">
                                <div><i class="fas fa-map-marker-alt mr-2"></i>Localisation: ${location}</div>
                                ${call.source ? `<div><i class="fas fa-info-circle mr-2"></i>Source: ${call.source}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erreur chargement historique:', error);
                document.getElementById('historyList').innerHTML = '<p class="text-center text-red-500">Erreur lors du chargement</p>';
            }
        }

        // Écouter les changements de période
        document.getElementById('historyPeriod').addEventListener('change', loadCallHistory);

        // ============================================
        // Gestion des Statistiques - Clients fréquents
        // ============================================
        
        // Charger les clients fréquents
        async function loadFrequentClients() {
            try {
                const frequentClientsDiv = document.getElementById('frequentClients');
                frequentClientsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';
                
                if (!driverData || !driverData.phone) {
                    frequentClientsDiv.innerHTML = '<p class="text-center text-gray-500">Aucune donnée disponible</p>';
                    return;
                }
                
                const driverPhone = driverData.phone.toString();
                const allCallsSnapshot = await db.collection('calls').get();
                
                const clientCounts = {};
                
                allCallsSnapshot.forEach((doc) => {
                    const callData = doc.data();
                    const callPhone = callData.phoneNumber ? callData.phoneNumber.toString().replace('+227', '').replace('227', '') : '';
                    
                    if (callPhone === driverPhone && callData.callType !== 'admin') {
                        const clientPhone = callData.clientPhone || callData.fromPhone || 'Inconnu';
                        clientCounts[clientPhone] = (clientCounts[clientPhone] || 0) + 1;
                    }
                });
                
                const sortedClients = Object.entries(clientCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                if (sortedClients.length === 0) {
                    frequentClientsDiv.innerHTML = '<p class="text-center text-gray-500 py-4">Aucun client fréquent pour le moment</p>';
                    return;
                }
                
                frequentClientsDiv.innerHTML = sortedClients.map(([phone, count], index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center font-bold text-green-600">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-semibold">+227${phone}</div>
                                <div class="text-sm text-gray-600">${count} appel${count > 1 ? 's' : ''}</div>
                            </div>
                        </div>
                        <button onclick="callClient('${phone}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-phone mr-2"></i>Appeler
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erreur chargement clients fréquents:', error);
                document.getElementById('frequentClients').innerHTML = '<p class="text-center text-red-500">Erreur lors du chargement</p>';
            }
        }

        // Appeler un client
        window.callClient = function(phone) {
            window.location.href = `tel:+227${phone}`;
        };

        // ============================================
        // Gestion des Paramètres
        // ============================================
        
        // Appliquer la couleur du thème
        window.applyThemeColor = function() {
            const color = document.getElementById('themeColor').value;
            localStorage.setItem('driverThemeColor', color);
            
            // Appliquer la couleur aux éléments principaux
            document.documentElement.style.setProperty('--theme-color', color);
            const nav = document.querySelector('nav');
            if (nav) {
                nav.style.background = `linear-gradient(to right, ${color}, ${adjustColor(color, -20)})`;
            }
            
            alert('Couleur du thème appliquée !');
        };

        // Réinitialiser la couleur du thème
        window.resetThemeColor = function() {
            localStorage.removeItem('driverThemeColor');
            document.getElementById('themeColor').value = '#10b981';
            document.documentElement.style.setProperty('--theme-color', '#10b981');
            location.reload();
        };

        // Charger la couleur du thème sauvegardée
        function loadThemeColor() {
            const savedColor = localStorage.getItem('driverThemeColor');
            if (savedColor) {
                document.getElementById('themeColor').value = savedColor;
                applyThemeColor();
            }
        }

        // Fonction utilitaire pour ajuster la couleur
        function adjustColor(color, amount) {
            const num = parseInt(color.replace("#", ""), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return "#" + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        // Supprimer le compte
        window.deleteAccount = async function() {
            if (!confirm('Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est irréversible.')) {
                return;
            }
            
            const confirmation = prompt('Tapez "SUPPRIMER" pour confirmer la suppression de votre compte :');
            if (confirmation !== 'SUPPRIMER') {
                alert('Suppression annulée.');
                return;
            }
            
            try {
                await db.collection('drivers').doc(currentDriverId).update({
                    isOnline: false,
                    status: 'deleted',
                    deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Votre compte a été supprimé. Vous allez être redirigé.');
                window.location.href = 'Dréba VTC.html';
            } catch (error) {
                console.error('Erreur suppression compte:', error);
                alert('Erreur lors de la suppression du compte.');
            }
        };

        // Initialisation au chargement
        window.addEventListener('load', function() {
            checkDriverSession();
            loadThemeColor();
        });
    </script>
</body>
</html>

